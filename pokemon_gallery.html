<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeAkane ポケモン図鑑</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* 固定ヘッダー */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0 0 15px 0;
            text-align: center;
            font-size: 2rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 世代切り替えボタン */
        .generation-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .gen-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff6b9d, #4facfe);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .gen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .gen-btn.active {
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            transform: scale(1.05);
        }

        /* ソフト毎ボタン */
        .software-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .soft-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg, #ffa726, #ff7043);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            min-width: 40px;
        }

        .soft-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .soft-btn.active {
            background: linear-gradient(45deg, #66bb6a, #42a5f5);
            transform: scale(1.05);
        }

        /* 検索エリア */
        .search-area {
            display: grid;
            grid-template-columns: 1fr 180px 150px 150px;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .type-select, .filter-select {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .type-filter-container {
            position: relative;
        }

        .type-dropdown summary {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            font-size: 0.9rem;
            cursor: pointer;
            list-style: none;
        }

        .type-checkbox-list {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 15px;
            min-width: 200px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .type-checkbox-list label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
        }

        .type-checkbox-list label:hover {
            background: #f8f9fa;
        }

        /* メインコンテンツ */
        .main-content {
            margin-top: 280px;
            padding: 20px;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px 20px;
            row-gap: 40px;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* 30個ごと（5行ごと）に区切り線を引く */
        .pokemon-card:nth-child(30n) {
            position: relative;
        }

        .pokemon-card:nth-child(30n)::after {
            content: '';
            position: absolute;
            top: calc(100% + 25px);
            left: -100vw;
            right: -100vw;
            width: 200vw;
            height: 10px;
            background: #ff1493;
            z-index: 999;
            box-shadow: 0 3px 15px rgba(255, 20, 147, 0.9);
            border-radius: 5px;
            display: block !important;
            visibility: visible !important;
        }

        /* 実際のHTML要素としての区切り線 */
        .row-separator {
            grid-column: 1 / -1;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ff69b4, transparent);
            margin: 15px 0;
            width: 100%;
            border-radius: 2px;
        }

        .pokemon-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .pokemon-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b9d, #4facfe, #43e97b, #f093fb);
            border-radius: 17px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pokemon-card:hover::before {
            opacity: 1;
        }

        .pokemon-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 105, 180, 0.4);
        }

        .pokemon-number {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pokemon-image-container {
            position: relative;
            display: inline-block;
            margin-bottom: 8px;
        }

        .pokemon-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 5px;
        }

        .pokemon-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .pokemon-types {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .type-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .type-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        /* タイプ別色分け */
        .type-ノーマル { background: #A8A878; }
        .type-ほのお { background: #F08030; }
        .type-みず { background: #6890F0; }
        .type-でんき { background: #F8D030; }
        .type-くさ { background: #78C850; }
        .type-こおり { background: #98D8D8; }
        .type-かくとう { background: #C03028; }
        .type-どく { background: #A040A0; }
        .type-じめん { background: #E0C068; }
        .type-ひこう { background: #A890F0; }
        .type-エスパー { background: #F85888; }
        .type-むし { background: #A8B820; }
        .type-いわ { background: #B8A038; }
        .type-ゴースト { background: #705898; }
        .type-ドラゴン { background: #7038F8; }
        .type-あく { background: #705848; }
        .type-はがね { background: #B8B8D0; }
        .type-フェアリー { background: #EE99AC; }

        /* 詳細モーダル */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            color: white;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .pokemon-detail-image {
            width: 200px;
            height: 200px;
            object-fit: contain;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 0 auto;
        }

        /* 進化表示のスタイル */
        .evolution-display {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .evolution-step {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .evolution-step.branched {
            flex-direction: column;
            align-items: center;
        }

        .evolution-pokemon {
            text-align: center;
            transition: transform 0.3s ease;
        }

        .evolution-pokemon:hover {
            transform: scale(1.05);
        }

        .evolution-arrow {
            font-size: 1.5rem;
            color: #ff69b4;
            font-weight: bold;
            margin: 0 10px;
        }

        .evolution-branches {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .evolution-branch {
            text-align: center;
            transition: transform 0.3s ease;
        }

        .evolution-branch:hover {
            transform: scale(1.1);
        }

        .detail-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .detail-section h3 {
            margin: 0 0 10px 0;
            color: #43e97b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .external-links {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .external-link {
            padding: 8px 16px;
            background: linear-gradient(45deg, #ff6b9d, #4facfe);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .external-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .search-area {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .modal-body {
                grid-template-columns: 1fr;
            }
            
            .generation-buttons {
                gap: 5px;
            }
            
            .gen-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }

        /* ローディング */
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 固定ヘッダー -->
    <div class="header">
        <h1>PokeAkane ポケモン図鑑</h1>
        
        <!-- 世代切り替えボタン -->
        <div class="generation-buttons">
            <button class="gen-btn active" data-gen="all">全国図鑑</button>
            <button class="gen-btn" data-gen="1">第1世代</button>
            <button class="gen-btn" data-gen="2">第2世代</button>
            <button class="gen-btn" data-gen="3">第3世代</button>
            <button class="gen-btn" data-gen="4">第4世代</button>
            <button class="gen-btn" data-gen="5">第5世代</button>
            <button class="gen-btn" data-gen="6">第6世代</button>
            <button class="gen-btn" data-gen="7">第7世代</button>
            <button class="gen-btn" data-gen="8">第8世代</button>
            <button class="gen-btn" data-gen="9">第9世代</button>
        </div>

        <!-- ソフト毎ボタン -->
        <div class="software-buttons">
            <button class="soft-btn active" data-soft="all">全て</button>
            <button class="soft-btn" data-soft="rby">赤緑青ピカ</button>
            <button class="soft-btn" data-soft="frlg">FRLG</button>
            <button class="soft-btn" data-soft="gsc">金銀ク</button>
            <button class="soft-btn" data-soft="hgss">HGSS</button>
            <button class="soft-btn" data-soft="rse">RSE</button>
            <button class="soft-btn" data-soft="oras">ORAS</button>
            <button class="soft-btn" data-soft="dpp">DPPt</button>
            <button class="soft-btn" data-soft="bdsp">BDSP</button>
            <button class="soft-btn" data-soft="bw">BW</button>
            <button class="soft-btn" data-soft="b2w2">B2W2</button>
            <button class="soft-btn" data-soft="xy">XY</button>
            <button class="soft-btn" data-soft="sm">SM</button>
            <button class="soft-btn" data-soft="usum">USUM</button>
            <button class="soft-btn" data-soft="lgpe">LGPE</button>
            <button class="soft-btn" data-soft="swsh">剣盾</button>
            <button class="soft-btn" data-soft="la">レジェアル</button>
            <button class="soft-btn" data-soft="sv">SV</button>
        </div>

        <!-- 検索エリア -->
        <div class="search-area">
            <input type="text" class="search-box" id="searchInput" placeholder="ポケモン名または図鑑No.で検索...">
            
            <div class="type-filter-container">
                <details class="type-dropdown">
                    <summary>タイプ選択（複数可）</summary>
                    <div class="type-checkbox-list">
                        <label><input type="checkbox" value="ノーマル"> ノーマル</label>
                        <label><input type="checkbox" value="ほのお"> ほのお</label>
                        <label><input type="checkbox" value="みず"> みず</label>
                        <label><input type="checkbox" value="でんき"> でんき</label>
                        <label><input type="checkbox" value="くさ"> くさ</label>
                        <label><input type="checkbox" value="こおり"> こおり</label>
                        <label><input type="checkbox" value="かくとう"> かくとう</label>
                        <label><input type="checkbox" value="どく"> どく</label>
                        <label><input type="checkbox" value="じめん"> じめん</label>
                        <label><input type="checkbox" value="ひこう"> ひこう</label>
                        <label><input type="checkbox" value="エスパー"> エスパー</label>
                        <label><input type="checkbox" value="むし"> むし</label>
                        <label><input type="checkbox" value="いわ"> いわ</label>
                        <label><input type="checkbox" value="ゴースト"> ゴースト</label>
                        <label><input type="checkbox" value="ドラゴン"> ドラゴン</label>
                        <label><input type="checkbox" value="あく"> あく</label>
                        <label><input type="checkbox" value="はがね"> はがね</label>
                        <label><input type="checkbox" value="フェアリー"> フェアリー</label>
                    </div>
                </details>
            </div>

            <select class="filter-select" id="sortOrder">
                <option value="id">番号順</option>
                <option value="stats_total">種族値合計順</option>
                <option value="hp">HP順</option>
                <option value="attack">攻撃順</option>
                <option value="defense">防御順</option>
                <option value="special_attack">特攻順</option>
                <option value="special_defense">特防順</option>
                <option value="speed">素早さ順</option>
            </select>

            <select class="filter-select" id="evolutionFilter">
                <option value="">進化フィルター</option>
                <option value="final">最終進化系</option>
                <option value="middle">中間進化</option>
                <option value="basic">進化前</option>
            </select>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content">
        <div class="loading" id="loading">データ読み込み中...</div>
        <div class="pokemon-grid" id="pokemonGrid"></div>
    </div>

    <!-- 詳細モーダル -->
    <div id="pokemonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ポケモン詳細</div>
                <button class="close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 詳細内容がここに動的に追加される -->
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let pokemonData = {};
        let generationData = {}; // 世代別データキャッシュ
        let currentGeneration = 'all';
        let currentSoftware = 'all';
        let filteredPokemon = [];

        // 世代別範囲
        const generations = {
            1: [1, 151],
            2: [152, 251], 
            3: [252, 386],
            4: [387, 493],
            5: [494, 649],
            6: [650, 721],
            7: [722, 809],
            8: [810, 905],
            9: [906, 1025]
        };

        // ソフト毎のポケモンリスト
        const softwarePokedex = {
            'rby': [1, 151], // 赤緑青ピカチュウ
            'frlg': [1, 386], // ファイアレッド・リーフグリーン（第3世代まで）
            'gsc': [1, 251], // 金銀クリスタル
            'hgss': [1, 493], // ハートゴールド・ソウルシルバー（第4世代まで）
            'rse': [1, 386], // ルビー・サファイア・エメラルド
            'oras': [1, 721], // オメガルビー・アルファサファイア（第6世代まで）
            'dpp': [1, 493], // ダイヤモンド・パール・プラチナ
            'bdsp': [1, 493], // ブリリアントダイヤモンド・シャイニングパール
            'bw': [1, 649], // ブラック・ホワイト
            'b2w2': [1, 649], // ブラック2・ホワイト2
            'xy': [1, 721], // X・Y
            'sm': [1, 809], // サン・ムーン
            'usum': [1, 809], // ウルトラサン・ウルトラムーン
            'lgpe': [1, 151], // Let's Go ピカチュウ・イーブイ（カントーのみ）
            'swsh': [1, 905], // ソード・シールド
            'la': [1, 905], // レジェンズアルセウス（第8世代まで）
            'sv': [1, 1025] // スカーレット・バイオレット
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPokemonData();
            setupEventListeners();
            displayPokemon();
        });

        // ポケモンデータ読み込み（世代別対応）
        async function loadPokemonData() {
            try {
                document.getElementById('loading').textContent = '世代別データを読み込み中...';
                
                // 世代別ファイルマップ
                const genFiles = {
                    'gen1': 'gen1_pokemon.json',
                    'gen2': 'gen2_pokemon.json', 
                    'gen3': 'gen3_pokemon.json',
                    'gen4': 'gen4_pokemon.json',
                    'gen5': 'gen5_pokemon.json',
                    'gen6': 'gen6_pokemon.json',
                    'gen7': 'gen7_pokemon.json',
                    'gen8': 'gen8_pokemon.json',
                    'gen9': 'gen9_pokemon.json',
                    'all': 'pokemon_data.json'  // 後方互換用
                };

                // 全世代のデータを並行読み込み
                const loadPromises = Object.values(genFiles).slice(0, -1).map(async file => {
                    try {
                        const response = await fetch(file);
                        if (!response.ok) throw new Error(`${file} が見つかりません`);
                        return await response.json();
                    } catch (error) {
                        console.warn(`${file} の読み込みに失敗:`, error);
                        return {};
                    }
                });

                // 全世代データを統合
                const genDataArrays = await Promise.all(loadPromises);
                pokemonData = genDataArrays.reduce((combined, genData) => {
                    return { ...combined, ...genData };
                }, {});

                // 世代別データも保存（メモリ効率のため）
                generationData = {
                    'gen1': genDataArrays[0] || {},
                    'gen2': genDataArrays[1] || {},
                    'gen3': genDataArrays[2] || {},
                    'gen4': genDataArrays[3] || {},
                    'gen5': genDataArrays[4] || {},
                    'gen6': genDataArrays[5] || {},
                    'gen7': genDataArrays[6] || {},
                    'gen8': genDataArrays[7] || {},
                    'gen9': genDataArrays[8] || {},
                    'all': pokemonData
                };

                console.log('世代別データ読み込み完了:', Object.keys(pokemonData).length + '匹');
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                // フォールバック: 元のファイルを試す
                try {
                    const response = await fetch('pokemon_data.json');
                    pokemonData = await response.json();
                    generationData = { 'all': pokemonData };
                    console.log('フォールバック読み込み完了:', Object.keys(pokemonData).length + '匹');
                    document.getElementById('loading').style.display = 'none';
                } catch (fallbackError) {
                    console.error('フォールバック読み込みエラー:', fallbackError);
                    document.getElementById('loading').textContent = 'データ読み込みに失敗しました';
                }
            }
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // 世代ボタン
            document.querySelectorAll('.gen-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.gen-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentGeneration = e.target.dataset.gen;
                    displayPokemon();
                });
            });

            // ソフト毎ボタン
            document.querySelectorAll('.soft-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.soft-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentSoftware = e.target.dataset.soft;
                    displayPokemon();
                });
            });

            // 検索機能
            document.getElementById('searchInput').addEventListener('input', displayPokemon);
            document.getElementById('evolutionFilter').addEventListener('change', displayPokemon);
            document.getElementById('sortOrder').addEventListener('change', displayPokemon);

            // タイプフィルター（チェックボックス）
            document.querySelectorAll('.type-checkbox-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', displayPokemon);
            });

            // モーダル
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('pokemonModal').addEventListener('click', (e) => {
                if (e.target.id === 'pokemonModal') closeModal();
            });
        }

        // ポケモン表示（世代別データ対応）
        function displayPokemon() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox-list input[type="checkbox"]:checked')).map(cb => cb.value);
            const evolutionFilter = document.getElementById('evolutionFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // 現在の世代のデータを取得（メモリ効率のため）
            let currentGenData;
            if (currentGeneration === 'all') {
                currentGenData = pokemonData;
            } else {
                // 世代番号をキーにマッピング
                const genKey = `gen${currentGeneration}`;
                currentGenData = generationData[genKey] || {};
            }

            // フィルタリング（選択された世代のデータのみ処理）
            filteredPokemon = Object.values(currentGenData).filter(pokemon => {
                // 検索フィルター
                if (searchTerm) {
                    const nameMatch = pokemon.name.toLowerCase().includes(searchTerm);
                    const idMatch = pokemon.id.toString().includes(searchTerm);
                    const formattedId = pokemon.id.toString().padStart(3, '0');
                    const formattedIdMatch = formattedId.includes(searchTerm);
                    if (!nameMatch && !idMatch && !formattedIdMatch) return false;
                }

                // タイプフィルター（複数選択対応）
                if (selectedTypes.length > 0) {
                    const hasAllSelectedTypes = selectedTypes.every(type => pokemon.types.includes(type));
                    if (!hasAllSelectedTypes) return false;
                }

                // 進化フィルター（実際の進化データを使用）
                if (evolutionFilter) {
                    const evolution = pokemon.evolution || {};
                    const hasEvolutionFrom = evolution.prev !== null && evolution.prev !== undefined;
                    const hasEvolutionTo = evolution.next && evolution.next.length > 0;
                    
                    if (evolutionFilter === 'basic') {
                        // 進化前：進化後があるが進化前がないもの
                        return hasEvolutionTo && !hasEvolutionFrom;
                    } else if (evolutionFilter === 'middle') {
                        // 中間進化：進化前と進化後の両方があるもの
                        return hasEvolutionFrom && hasEvolutionTo;
                    } else if (evolutionFilter === 'final') {
                        // 最終進化：進化後がないもの（無進化ポケモンも含む）
                        return !hasEvolutionTo;
                    }
                }

                // ソフト毎フィルター
                if (currentSoftware !== 'all') {
                    const softwareRange = softwarePokedex[currentSoftware];
                    if (softwareRange && (pokemon.id < softwareRange[0] || pokemon.id > softwareRange[1])) {
                        return false;
                    }
                }

                return true;
            });

            // ソート
            if (sortOrder === 'stats_total') {
                filteredPokemon.sort((a, b) => {
                    const statsA = Object.values(a.stats).reduce((sum, stat) => sum + stat, 0);
                    const statsB = Object.values(b.stats).reduce((sum, stat) => sum + stat, 0);
                    return statsB - statsA; // 降順
                });
            } else if (sortOrder === 'hp') {
                filteredPokemon.sort((a, b) => b.stats.hp - a.stats.hp);
            } else if (sortOrder === 'attack') {
                filteredPokemon.sort((a, b) => b.stats.attack - a.stats.attack);
            } else if (sortOrder === 'defense') {
                filteredPokemon.sort((a, b) => b.stats.defense - a.stats.defense);
            } else if (sortOrder === 'special_attack') {
                filteredPokemon.sort((a, b) => b.stats.special_attack - a.stats.special_attack);
            } else if (sortOrder === 'special_defense') {
                filteredPokemon.sort((a, b) => b.stats.special_defense - a.stats.special_defense);
            } else if (sortOrder === 'speed') {
                filteredPokemon.sort((a, b) => b.stats.speed - a.stats.speed);
            } else {
                filteredPokemon.sort((a, b) => a.id - b.id); // 番号順
            }

            renderPokemonGrid();
        }

        // ポケモンカード描画
        function renderPokemonGrid() {
            const grid = document.getElementById('pokemonGrid');
            
            if (filteredPokemon.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: white; font-size: 1.2rem;">該当するポケモンが見つかりませんでした</div>';
                return;
            }

            let htmlContent = '';
            filteredPokemon.forEach((pokemon, index) => {
                // 30匹（横5列）ごとに区切り線を追加
                if (index > 0 && index % 30 === 0) {
                    htmlContent += '<div class="row-separator"></div>';
                }
                
                const typesBadges = pokemon.types.map(type => 
                    `<span class="type-badge type-${type}">
                        <img src="type_images/${type}_backup.png" class="type-icon" alt="${type}">
                        ${type}
                    </span>`
                ).join('');

                htmlContent += `
                    <div class="pokemon-card" onclick="showPokemonDetail(${pokemon.id})">
                        <div class="pokemon-number">No.${pokemon.id.toString().padStart(3, '0')}</div>
                        <div class="pokemon-image-container">
                            <img src="pokemon_images/normal/${pokemon.id.toString().padStart(3, '0')}.png" 
                                 alt="${pokemon.name}" 
                                 class="pokemon-image" 
                                 id="pokemon-image-${pokemon.id}"
                                 loading="lazy"
                                 onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.id}.png'; this.onerror=function(){this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPgogIDx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj4jJHtwb2tlbW9uLmlkfTwvdGV4dD4KICA8dGV4dCB4PSI1MCIgeT0iNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Tm8gSW1hZ2U8L3RleHQ+Cjwvc3ZnPg==';}">
                        </div>
                        <div class="pokemon-name">${pokemon.name}</div>
                        <div class="pokemon-types">${typesBadges}</div>
                    </div>
                `;
            });

            grid.innerHTML = htmlContent;
        }

        // 進化表示を作成（分岐進化対応）
        function createEvolutionDisplay(pokemon) {
            const evolution = pokemon.evolution;
            let html = '<div class="evolution-display">';
            
            // 進化前がある場合
            if (evolution.prev) {
                const prevPokemon = findPokemonById(evolution.prev);
                const prevName = prevPokemon ? prevPokemon.name : `No.${evolution.prev}`;
                html += `
                    <div class="evolution-step">
                        <div class="evolution-pokemon prev">
                            <img src="pokemon_images/normal/${evolution.prev.toString().padStart(3, '0')}.png" 
                                 alt="${prevName}" 
                                 style="width: 80px; height: 80px; object-fit: contain; border-radius: 10px; background: #f8f9fa;">
                            <div style="font-size: 0.8rem; margin-top: 5px;">${prevName}</div>
                        </div>
                        <div class="evolution-arrow">→</div>
                    </div>
                `;
            }
            
            // 現在のポケモン（中央に大きく表示）
            html += `
                <div class="evolution-step current">
                    <div class="evolution-pokemon current">
                        <img src="pokemon_images/normal/${pokemon.id.toString().padStart(3, '0')}.png" 
                             alt="${pokemon.name}" 
                             style="width: 120px; height: 120px; object-fit: contain; border-radius: 15px; background: linear-gradient(145deg, #fff, #f0f0f0); box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);">
                        <div style="font-size: 1rem; margin-top: 8px; font-weight: bold; color: #ff69b4;">${pokemon.name}</div>
                    </div>
                </div>
            `;
            
            // 進化後がある場合
            if (evolution.next && evolution.next.length > 0) {
                if (evolution.next.length === 1) {
                    // 単一進化
                    const nextPokemon = findPokemonById(evolution.next[0]);
                    const nextName = nextPokemon ? nextPokemon.name : `No.${evolution.next[0]}`;
                    html += `
                        <div class="evolution-step">
                            <div class="evolution-arrow">→</div>
                            <div class="evolution-pokemon next">
                                <img src="pokemon_images/normal/${evolution.next[0].toString().padStart(3, '0')}.png" 
                                     alt="${nextName}" 
                                     style="width: 80px; height: 80px; object-fit: contain; border-radius: 10px; background: #f8f9fa;">
                                <div style="font-size: 0.8rem; margin-top: 5px;">${nextName}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // 分岐進化
                    html += `
                        <div class="evolution-step branched">
                            <div class="evolution-arrow">→</div>
                            <div class="evolution-branches">
                    `;
                    
                    evolution.next.forEach((nextId, index) => {
                        const nextPokemon = findPokemonById(nextId);
                        const nextName = nextPokemon ? nextPokemon.name : `No.${nextId}`;
                        html += `
                            <div class="evolution-branch" style="margin: 5px;">
                                <img src="pokemon_images/normal/${nextId.toString().padStart(3, '0')}.png" 
                                     alt="${nextName}" 
                                     style="width: 70px; height: 70px; object-fit: contain; border-radius: 8px; background: #f8f9fa;">
                                <div style="font-size: 0.75rem; margin-top: 3px; text-align: center;">${nextName}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }

        // ポケモンIDで検索するヘルパー関数
        function findPokemonById(pokemonId) {
            // まず統合データから検索
            let pokemon = pokemonData[pokemonId.toString()];
            
            // 見つからない場合は世代別データから検索
            if (!pokemon && generationData) {
                for (const genKey in generationData) {
                    const genData = generationData[genKey];
                    if (genData[pokemonId.toString()]) {
                        pokemon = genData[pokemonId.toString()];
                        break;
                    }
                }
            }
            
            return pokemon;
        }

        // ポケモン詳細表示
        function showPokemonDetail(pokemonId) {
            // 全データから検索（統合データまたは現在の世代データから）
            let pokemon = pokemonData[pokemonId.toString()];
            
            // 統合データにない場合は、世代別データから検索
            if (!pokemon && generationData) {
                for (const genKey in generationData) {
                    const genData = generationData[genKey];
                    if (genData[pokemonId.toString()]) {
                        pokemon = genData[pokemonId.toString()];
                        break;
                    }
                }
            }
            
            if (!pokemon) {
                console.error(`ポケモンID ${pokemonId} が見つかりません`);
                return;
            }

            const modal = document.getElementById('pokemonModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `#${pokemon.id.toString().padStart(3, '0')} ${pokemon.name}`;
            
            // 進化系表示を改善（分岐進化対応）
            const evolutionDisplay = createEvolutionDisplay(pokemon);

            modalBody.innerHTML = `
                <div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        ${evolutionDisplay}
                    </div>
                    
                    <div class="detail-section">
                        <h3>基本情報</h3>
                        <p><strong>タイプ:</strong> ${pokemon.types.join(' / ')}</p>
                        <p><strong>特性:</strong> ${pokemon.abilities.join(', ')}</p>
                        <p><strong>高さ:</strong> ${pokemon.height}m</p>
                        <p><strong>重さ:</strong> ${pokemon.weight}kg</p>
                        <p><strong>世代:</strong> 第${pokemon.generation}世代</p>
                    </div>

                    <div class="external-links">
                        <a href="${pokemon.external_links.kouryaku}" target="_blank" class="external-link">徹底攻略</a>
                        <a href="${pokemon.external_links.gamewith}" target="_blank" class="external-link">GameWith</a>
                        <a href="${pokemon.external_links.game8}" target="_blank" class="external-link">Game8</a>
                    </div>
                </div>

                <div>
                    <div class="detail-section">
                        <h3>種族値</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span>HP</span>
                                <span>${pokemon.stats.hp}</span>
                            </div>
                            <div class="stat-item">
                                <span>攻撃</span>
                                <span>${pokemon.stats.attack}</span>
                            </div>
                            <div class="stat-item">
                                <span>防御</span>
                                <span>${pokemon.stats.defense}</span>
                            </div>
                            <div class="stat-item">
                                <span>特攻</span>
                                <span>${pokemon.stats.special_attack}</span>
                            </div>
                            <div class="stat-item">
                                <span>特防</span>
                                <span>${pokemon.stats.special_defense}</span>
                            </div>
                            <div class="stat-item">
                                <span>素早さ</span>
                                <span>${pokemon.stats.speed}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // モーダル閉じる
        function closeModal() {
            document.getElementById('pokemonModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ESCキーでモーダル閉じる
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // 画像関連の処理（削除済み）

        // 利用可能な画像リストをキャッシュ
        const availableImages = {};

        // 画像関連の処理（削除済み）
    </script>
</body>
</html>